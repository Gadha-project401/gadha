<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/server.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/server.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';
/**
 * express server  
 * @module server 
 * @requires dotenv
 * @requires cors
 * @requires express
 * @requires http
 * @requires socket.io
 * @requires timestamp
 * @requires logger
 * @requires errorHandler
 * @requires notFoundHandler
 */

// Outside modules 
require('dotenv').config();
const cors = require('cors');
const express = require('express');
const app = express();
const server = require('http').createServer(app);
const io = require('socket.io')(server);

// My modules 
const timeStamp = require('../middleware/timestamp');
const logger = require('../middleware/logger');
const errorHandler = require('../middleware/500');
const notFoundHandler = require('../middleware/404');
const routes = require('../routes/routes');

// Global Middleware 
app.use(express.static('./public'));
app.use('/docs', express.static('./docs'));
app.use(express.json());
app.use(cors());
app.use(timeStamp);
app.use(logger);

// Using the Routers modules 
app.use(routes);

// chat rout 
app.get('/chat',(req,res)=>{
  res.sendFile(__dirname + '/chat.html');
  // res.redirect()
});

// socket for chat server 
let users =[];
let connections = [];

/**
 * @method on 
 * @param {string} connection A new Socket was connected.
 * 
 */
io.sockets.on('connection',function(socket){
  connections.push(socket);
  console.log('connected %s sockets connected ', connections.length);

  /**
   * @method on 
   * 
   * @param {string} disconnect A Socket was disconnected.
   */

  /**
    * @function disconnect
    * @param {string} data The disconnected user's data.
    */

  socket.on('disconnect',(data)=>{
    users.splice(users.indexOf(socket.username),1);
    updateUserNames();
    connections.splice(connections.indexOf(socket),1);
    console.log('Disconnected : %s sockets connected' , connections.length);
  });

  /**
   * @method on 
   * @param {string} sendmessage received message from clients.
   */
  /**
   * @method emit 
   * @param {string} newmessage The message that will be broadcasted to all clients.
   * @param {object} obj An object containing the message and the username.
   */

  socket.on('send message',(data)=>{
    let obj =  {msg:data , user:socket.username};
    io.sockets.emit('new message',obj);
  });
   
  /**
   * @method on 
   * @param {string} newuser The name of the newly connected user from client.
   */

  socket.on('new user',(data,callback)=>{
    callback(true);
    socket.username = data;
    users.push(socket.username);
    updateUserNames();
  });

  /**
   * @method on 
   * @param {string} sendpost The received notifications from clients.
   */
  /**
   * @method emit 
   * @param {string} not Broadcast the notification to all clients.
   * @param {string} data The message object.
   */

  socket.on('send post',data=>{
    io.sockets.emit('not',data);
  });

  /**
   * @function updateUserNames
   * @description To update the currently connected users.
   */
  function updateUserNames(){
    io.sockets.emit('get users', users);
  }
});


// Not found handler
app.use('*',notFoundHandler);

//Error handler
app.use(errorHandler);

module.exports = {
  server: app,
  start: (port)=>{
    const PORT = port || process.env.PORT || 3000;
    server.listen(PORT, ()=>{console.log(`Listening to port ${PORT}`);});
  },
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-authorization.html">authorization</a></li><li><a href="module-basic.html">basic</a></li><li><a href="module-bearerAuth.html">bearerAuth</a></li><li><a href="module-goalsModel.html">goalsModel</a></li><li><a href="module-goalsSchema.html">goalsSchema</a></li><li><a href="module-GoogleOAuth.html">GoogleOAuth</a></li><li><a href="module-linkedInOAuth.html">linkedInOAuth</a></li><li><a href="module-motivationModel.html">motivationModel</a></li><li><a href="module-motivationSchema.html">motivationSchema</a></li><li><a href="module-Routes.html">Routes</a></li><li><a href="module-server.html">server</a></li><li><a href="module-users.html">users</a></li></ul><h3>Classes</h3><ul><li><a href="module-goalsModel-Model.html">Model</a></li><li><a href="module-motivationModel-Model.html">Model</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Tue Jun 23 2020 17:53:52 GMT+0300 (Eastern European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
